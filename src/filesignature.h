#ifndef FILESIGNATURE_H
#define FILESIGNATURE_H

#include <iostream>
#include <fstream>
#include <set>
#include <vector>
#include <sstream>
#include <iomanip>

#include <string.h>
#include <errno.h>


#ifndef SIGNATURE_SET_NAME
    #define SIGNATURE_SET_NAME known_signatures
#endif

#ifndef BRACED_INIT_LIST
    #define BRACED_INIT_LIST(...) {__VA_ARGS__}
#endif

#ifndef ADD_SIGNATURE
    #define ADD_SIGNATURE(sig, b) \
          SIGNATURE_SET_NAME.emplace<vector<unsigned char>, string> \
                    (BRACED_INIT_LIST sig, b);
#endif



namespace mw {

  using namespace std;

  struct Signature;

  using signature_set       = multiset<Signature>;
  using signature_set_iter  = multiset<Signature>::iterator;
  using signature_set_riter = multiset<Signature>::reverse_iterator;



  struct Signature
  {
     vector<unsigned char> sig;
     string img_type;

     Signature();

     Signature(const vector<unsigned char> & sig_,
               const string & img_type_ = "");

     bool operator <  (const Signature & other) const;
     bool operator == (const Signature & other) const;

  };


  set<int>
  get_known_signatures_lengths();

  string
  get_signature_as_string(const vector<unsigned char> & signature);


  vector<unsigned char>
  get_bin_signature(const string & in_file, int length = 132);



  /**
   * @brief returns a reference to the multiset of signatures containing known signatures.
   *        New signatures are compared against this set to determine the file type.
   * @return
   */
  inline signature_set &
  get_known_signatures()
  {
      static signature_set SIGNATURE_SET_NAME;

      if (!SIGNATURE_SET_NAME.empty())
      {
          return SIGNATURE_SET_NAME;
      }

      ADD_SIGNATURE((0x42, 0x4D),             "BMP");

      ADD_SIGNATURE((0x42, 0x4D),             "CHM");

      ADD_SIGNATURE((0xD0, 0xCF, 0x11, 0xE0,
                     0xA1, 0xB1, 0x1A, 0xE1,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00), "DB");

      ADD_SIGNATURE((0x49, 0x54, 0x53, 0x46), "DIB");

      ADD_SIGNATURE((0x4D, 0x5A),             "DLL");


      ADD_SIGNATURE((0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00,
                     0x44, 0x49, 0x43, 0x4D), "DCM");

      ADD_SIGNATURE((0x50, 0x4B, 0x03, 0x04,
                     0x14, 0x00, 0x06, 0x00), "DOCX");

      ADD_SIGNATURE((0x4D, 0x5A, 0x90, 0x00,
                     0x03, 0x00, 0x00, 0x00,
                     0x04, 0x00, 0x00, 0x00,
                                 0xFF, 0xFF), "EXE");



      ADD_SIGNATURE((0x47, 0x49, 0x46, 0x38,
                                 0x37, 0x61), "GIF");

      ADD_SIGNATURE((0x47, 0x49, 0x46, 0x38,
                                 0x39, 0x61), "GIF");

      ADD_SIGNATURE((0x3C, 0x21),             "HTML");

      ADD_SIGNATURE((0x00, 0x00, 0x01, 0x00), "ICO");

      ADD_SIGNATURE((0x69, 0x63, 0x6E, 0x73), "ICNS");

      ADD_SIGNATURE((0xFF, 0xD8, 0xFF, 0xE1), "JPEG");
      ADD_SIGNATURE((0xFF, 0xD8, 0xFF, 0xE0), "JPEG");
      ADD_SIGNATURE((0xFF, 0xD8, 0xFF, 0xE8), "JPEG");

      ADD_SIGNATURE(( 0x4D, 0x41, 0x54, 0x4C,
                      0x41, 0x42, 0x20, 0x35,
                      0x2E, 0x30, 0x20, 0x4D,
                      0x41, 0x54, 0x2D, 0x66,
                      0x69, 0x6C, 0x65),      "MAT");


      ADD_SIGNATURE((0x0C, 0xED),             "MP");

      ADD_SIGNATURE((0x4D, 0x4D, 0x00, 0x2A,
                     0x00, 0x00, 0x00, 0x08,
                                       0x00), "NEF");

      ADD_SIGNATURE((0x49, 0x49, 0x2A, 0x00,
                     0x08, 0x00, 0x00, 0x00,
                                       0x1A), "NEF");

      ADD_SIGNATURE((0x25, 0x50, 0x44, 0x46), "PDF");

      ADD_SIGNATURE((0x89, 0x50, 0x4E, 0x47,
                     0x0D, 0x0A, 0x1A, 0x0A), "PNG");

      ADD_SIGNATURE((0x50, 0x4B, 0x03, 0x04,
                     0x14, 0x00, 0x06, 0x00), "PPTX");

      ADD_SIGNATURE((0x38, 0x42, 0x50, 0x53), "PSD");

      ADD_SIGNATURE((0x49, 0x20, 0x49),       "TIFF");
      ADD_SIGNATURE((0x4D, 0x4D, 0x00, 0x2A), "TIFF");
      ADD_SIGNATURE((0x4D, 0x4D, 0x00, 0x2B), "TIFF");
      ADD_SIGNATURE((0x49, 0x49, 0x2A, 0x00), "TIFF");

      ADD_SIGNATURE((0x67, 0x69, 0x6D, 0x70,
                     0x20, 0x78, 0x63, 0x66,
                     0x20, 0x66, 0x69, 0x6C,
                                       0x65), "XCF");

      ADD_SIGNATURE((0x50, 0x4B, 0x03, 0x04,
                     0x14, 0x00, 0x06, 0x00), "XLSX");

      ADD_SIGNATURE((0x3C                  ), "XML");


      ADD_SIGNATURE((0x50, 0x4B, 0x03, 0x04), "ZIP");




      return SIGNATURE_SET_NAME;
  }




 }


#endif // FILESIGNATURE_H
